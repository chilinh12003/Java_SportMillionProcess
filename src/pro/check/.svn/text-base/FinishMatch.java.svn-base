package MyProcess;

import java.text.SimpleDateFormat;
import java.util.Calendar;
import java.util.Vector;
import MyDataSource.MyDataRow;
import MyDataSource.MyTableModel;
import MyDefine.FinishMatchObject;
import MyDefine.RandomCodeObject;

import MyProcessServer.Common;
import MyProcessServer.ConsoleSRV;
import MyProcessServer.LocalConfig;
import MyUtility.MyConfig;
import MyUtility.MyLogger;
import Service.Answer;
import Service.AnswerLog;
import Service.AnswerObject;
import Service.DefineCode;
import Service.MOLog;
import Service.Match;
import Service.SubCode;
import Service.DefineMT.MTType;

public class FinishMatch extends Thread
{
	MyLogger mLog = new MyLogger(this.getClass().toString());

	public FinishMatchObject mFMObject = new FinishMatchObject();

	public FinishMatch()
	{

	}

	public FinishMatch(FinishMatchObject mFMObject)
	{
		this.mFMObject = mFMObject;
	}

	Match mMatch = null;
	Answer mAnswer = null;
	SubCode mSubCode = null;
	MOLog mMOLog = null;
	AnswerLog mAnswerLog = null;

	DefineCode mDefineCode = null;
	MyTableModel mTable_SubCode = null;
	MyTableModel mTable_MOLog = null;
	MyTableModel mTable_AnswerLog = null;
	MyTableModel mTable_Answer = null;

	public SimpleDateFormat DateFormat_InsertDB = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss.SSS");

	Integer TotalCount = 0;

	public void run()
	{
		if (ConsoleSRV.processData)
		{
			try
			{
				mMatch = new Match(LocalConfig.PoolName_Data_SQL);
				mAnswer = new Answer(LocalConfig.PoolName_Data_SQL);
				mSubCode = new SubCode(LocalConfig.PoolName_Data_SQL);
				mDefineCode = new DefineCode(LocalConfig.PoolName_Data_SQL);
				mMOLog = new MOLog(LocalConfig.PoolName_Data_SQL);
				mAnswerLog = new AnswerLog(LocalConfig.PoolName_Data_SQL);

				mTable_AnswerLog = mAnswerLog.Select(0);
				mTable_MOLog = mMOLog.Select(0);
				mTable_SubCode = mSubCode.Select(0);
				mTable_Answer = mAnswer.Select(0);

				PushForEach();
			}
			catch (Exception ex)
			{
				mLog.log.error("Loi xay ra trong qua trinh Finish Match, Thead Index:" + mFMObject.ProcessIndex, ex);
			}
		}
	}

	private boolean PushForEach() throws Exception
	{
		MyTableModel mTable = new MyTableModel(null, null);
		Vector<AnswerObject> mList = new Vector<AnswerObject>();
		try
		{
			Integer MinPID = 0;

			for (Integer PID = MinPID; PID <= LocalConfig.MAX_PID; PID++)
			{
				mFMObject.CurrentPID = PID;
				mFMObject.MaxOrderID = 0;

				mTable = GetSubscriber(PID);

				while (!mTable.IsEmpty())
				{
					mList = AnswerObject.ConvertToList(mTable);

					for (AnswerObject mSubObj : mList)
					{
						// Nếu bị dừng đột ngột
						if (!ConsoleSRV.processData)
						{
							UpdateToAnswer();
							mList.clear();
							mLog.log.debug("Bi dung Finish Match: Finish Match Info:" + mFMObject.GetLogString(""));
							return false;
						}

						mFMObject.MaxOrderID = mSubObj.OrderID;
						if (mSubObj.IsCompute)
							continue;
						
						TotalCount++;

						// Chỉ tính toan với những sub đang hoạt động.
						// Cẩn thận lúc lấy code và xóa code khi có
						// nhiều process chạy
						Integer TotalMark = 0;
						Integer TotalCode = 0;
						Integer ChargeMark = mSubObj.MarkByDay;
						Integer MarkBT = 0;
						Integer MarkGB = 0;
						Integer MarkKQ = 0;
						Integer MarkTS = 0;
						Integer MarkTV = 0;

						if (!mFMObject.mMatchObj.AnswerBT.isEmpty() && mSubObj.AnswerBT.equalsIgnoreCase(mFMObject.mMatchObj.AnswerBT))
						{
							MarkBT = 500 + 50 * (mFMObject.NumberPromotion);
						}

						if (!mFMObject.mMatchObj.AnswerGB.isEmpty() && mSubObj.AnswerGB.equalsIgnoreCase(mFMObject.mMatchObj.AnswerGB))
						{
							MarkGB = 500 + 50 * (mFMObject.NumberPromotion);
						}

						if (!mFMObject.mMatchObj.AnswerKQ.isEmpty() && mSubObj.AnswerKQ.equalsIgnoreCase(mFMObject.mMatchObj.AnswerKQ))
						{
							MarkKQ = 500 + 50 * (mFMObject.NumberPromotion);
						}

						if (!mFMObject.mMatchObj.AnswerTS.isEmpty() && mSubObj.AnswerTS.equalsIgnoreCase(mFMObject.mMatchObj.AnswerTS))
						{
							MarkTS = 500 + 50 * (mFMObject.NumberPromotion);
						}

						if (!mFMObject.mMatchObj.AnswerTV.isEmpty() && mSubObj.AnswerTV.equalsIgnoreCase(mFMObject.mMatchObj.AnswerTV))
						{
							MarkTV = 500 + 50 * (mFMObject.NumberPromotion);
						}

						TotalMark = ChargeMark + MarkBT + MarkGB + MarkKQ + MarkTS + MarkTV;

						TotalCode = TotalMark / LocalConfig.MarkPerCode;

						Integer RetryCount = 1;
						boolean ResulCreate = false;

						// Sẽ retry n lần nếu việc insert Subcode không
						// thành công
						// Vì có thể do nhiều process chạy nên khi select
						// DefineCode có thể bị trùng Code
						// Việc retry đảm bảo insert đầy đủ code cho khách
						// hàng
						while (!ResulCreate && RetryCount < 4 && TotalMark > 0)
						{
							ResulCreate = CreateSubCode(mSubObj, TotalMark, RetryCount++);
						}

						if (ResulCreate)
						{
							AddToAnswerLog(mSubObj, ChargeMark, MarkBT, MarkGB, MarkKQ, MarkTS, MarkTV, TotalCode, TotalMark);

							// Không dự đoán thì không gửi MT thông báo
							if (!mSubObj.AnswerBT.isEmpty() || !mSubObj.AnswerGB.isEmpty() || !mSubObj.AnswerKQ.isEmpty() || !mSubObj.AnswerTS.isEmpty()
									|| !mSubObj.AnswerTV.isEmpty())
							{
								SendMT(mSubObj, TotalMark, TotalCode, ChargeMark);
							}
							mSubObj.IsCompute = true;
							mSubObj.ComputeDate = Calendar.getInstance().getTime();
							AddToAnswer(mSubObj);
						}
					}
					mLog.log.debug("Tao MDT thanh cong cho " + TotalCount + " Thue bao ProcessIndex:" + mFMObject.ProcessIndex);
					UpdateToAnswer();
					mList.clear();

					Insert_AnswerLog();
					Insert_MOLog();

					mTable.Clear();
					mTable = GetSubscriber(PID);
				}
			}
			return true;
		}
		catch (Exception ex)
		{
			mLog.log.debug("Loi trong Finish Match cho dich vu");
			throw ex;
		}
		finally
		{
			UpdateToAnswer();
			mList.clear();

			// Cập nhật thời gian kết thúc bắn tin
			mFMObject.FinishDate = Calendar.getInstance().getTime();
			mLog.log.debug("KET THUC TINH DIEM");
		}
	}

	private void AddToAnswer(AnswerObject mSubObj) throws Exception
	{
		try
		{
			MyDataRow mRow_Answer = mTable_Answer.CreateNewRow();

			mRow_Answer.SetValueCell("MSISDN", mSubObj.MSISDN);
			mRow_Answer.SetValueCell("MatchID", mSubObj.MatchID);
			mRow_Answer.SetValueCell("AnswerKQ", mSubObj.AnswerKQ);
			mRow_Answer.SetValueCell("AnswerBT", mSubObj.AnswerBT);
			mRow_Answer.SetValueCell("AnswerGB", mSubObj.AnswerGB);
			mRow_Answer.SetValueCell("AnswerTS", mSubObj.AnswerTS);
			mRow_Answer.SetValueCell("AnswerTV", mSubObj.AnswerTV);
			mRow_Answer.SetValueCell("MarkByDay", mSubObj.MarkByDay);
			mRow_Answer.SetValueCell("PID", mSubObj.PID);
			mRow_Answer.SetValueCell("OrderID", mSubObj.OrderID);
			mRow_Answer.SetValueCell("IsCompute", mSubObj.IsCompute ? 1 : 0);
			if (mSubObj.LastUpdate != null)
				mRow_Answer.SetValueCell("LastUpdate", DateFormat_InsertDB.format(mSubObj.LastUpdate));

			if (mSubObj.ComputeDate != null)
				mRow_Answer.SetValueCell("ComputeDate", DateFormat_InsertDB.format(mSubObj.ComputeDate));

			mTable_Answer.AddNewRow(mRow_Answer);

		}
		catch (Exception ex)
		{
			mLog.log.error(ex);
		}
	}

	private void UpdateToAnswer() throws Exception
	{
		try
		{
			if (mTable_Answer.GetRowCount() < 1)
				return;

			mAnswer.Update(1, mTable_Answer.GetXML());
		}
		catch (Exception ex)
		{
			mLog.log.error(ex);
		}
		finally
		{
			mTable_Answer.Clear();
		}
	}

	private boolean SendMT(AnswerObject mSubObj, Integer TotalMark, Integer TotalCode, Integer ChargeMark) throws Exception
	{
		// Diem tra loi
		Integer MatchMark = TotalMark - mSubObj.MarkByDay;

		String MTContent = Common.GetDefineMT_Message(MTType.NotifyResult);
		MTContent = MTContent.replace("[Match]", mFMObject.mMatchObj.GetMatchName());
		MTContent = MTContent.replace("[PlayHour]", mFMObject.mMatchObj.GetPlayHour());
		MTContent = MTContent.replace("[PlayDate]", mFMObject.mMatchObj.GetPlayDate());
		MTContent = MTContent.replace("[TotalMark]", MatchMark.toString());
		MTContent = MTContent.replace("[TotalCode]", TotalCode.toString());
		MTContent = MTContent.replace("[CodeDate]", mFMObject.mMatchObj.GetCodeDate());
		MTContent = MTContent.replace("[ChargeMark]", ChargeMark.toString());
		String REQUEST_ID = Long.toString(System.currentTimeMillis());
		if (Common.SendMT(mSubObj.MSISDN, "", MTContent, REQUEST_ID))
		{
			AddToMOLog(mSubObj, MTContent, MTType.NotifyResult, REQUEST_ID);
			return true;
		}
		return false;
	}

	private boolean CreateSubCode(AnswerObject mSubObj, Integer TotalMark, Integer RetryCount)
	{
		try
		{
			Integer NumberCode = TotalMark / LocalConfig.MarkPerCode;

			Vector<Integer> mList = RandomCodeObject.GetListCode(NumberCode);

			Integer Count = 0;
			mTable_SubCode.Clear();
			// Lấy thêm mã nếu còn thiếu
			for (Integer Code : mList)
			{
				MyDataRow mRow = mTable_SubCode.CreateNewRow();
				mRow.SetValueCell("Code", Code);
				mRow.SetValueCell("MSISDN", mSubObj.MSISDN);
				mRow.SetValueCell("MatchID", mFMObject.mMatchObj.MatchID);
				mRow.SetValueCell("CurrentMark", TotalMark - 50 * Count);
				mRow.SetValueCell("CodeDate", DateFormat_InsertDB.format(mFMObject.mMatchObj.CodeDate));
				mRow.SetValueCell("CreateDate", DateFormat_InsertDB.format(Calendar.getInstance().getTime()));
				mRow.SetValueCell("PID", mSubObj.PID);
				mTable_SubCode.AddNewRow(mRow);
				Count++;
			}
			if (mSubCode.Insert(0, mTable_SubCode.GetXML()))
			{
				return true;
			}
			else
			{
				return false;
			}
		}
		catch (Exception ex)
		{
			mLog.log.error("Loi khi insert SubCode, RetryCount:" + RetryCount, ex);
			return false;
		}
		finally
		{
		}
	}

	private void AddToAnswerLog(AnswerObject mSubObj, Integer ChargeMark, Integer MarkBT, Integer MarkGB, Integer MarkKQ, Integer MarkTS, Integer MarkTV,
			Integer TotalCode, Integer TotalMark) throws Exception
	{
		try
		{
			MyDataRow mRow_AnswerLog = mTable_AnswerLog.CreateNewRow();

			mRow_AnswerLog.SetValueCell("MSISDN", mSubObj.MSISDN);
			mRow_AnswerLog.SetValueCell("MatchID", mFMObject.mMatchObj.MatchID);
			mRow_AnswerLog.SetValueCell("CodeDate", DateFormat_InsertDB.format(mFMObject.mMatchObj.CodeDate));
			mRow_AnswerLog.SetValueCell("AnswerKQ", mSubObj.AnswerKQ);
			mRow_AnswerLog.SetValueCell("AnswerBT", mSubObj.AnswerBT);
			mRow_AnswerLog.SetValueCell("AnswerGB", mSubObj.AnswerGB);
			mRow_AnswerLog.SetValueCell("AnswerTS", mSubObj.AnswerTS);
			mRow_AnswerLog.SetValueCell("AnswerTV", mSubObj.AnswerTV);
			mRow_AnswerLog.SetValueCell("MarkKQ", MarkKQ);
			mRow_AnswerLog.SetValueCell("MarkBT", MarkBT);
			mRow_AnswerLog.SetValueCell("MarkGB", MarkGB);
			mRow_AnswerLog.SetValueCell("MarkTS", MarkTS);
			mRow_AnswerLog.SetValueCell("MarkTV", MarkTV);
			mRow_AnswerLog.SetValueCell("ChargeMark", ChargeMark);
			mRow_AnswerLog.SetValueCell("TotalMark", TotalMark);
			mRow_AnswerLog.SetValueCell("TotalCode", TotalCode);
			mRow_AnswerLog.SetValueCell("PID", mSubObj.PID);

			mTable_AnswerLog.AddNewRow(mRow_AnswerLog);

		}
		catch (Exception ex)
		{
			mLog.log.error(ex);
		}
	}

	private void Insert_AnswerLog() throws Exception
	{
		try
		{
			if (mTable_AnswerLog.IsEmpty())
				return;

			mAnswerLog.Insert(0, mTable_AnswerLog.GetXML());
		}
		catch (Exception ex)
		{
			mLog.log.error(ex);
		}
		finally
		{
			mTable_AnswerLog.Clear();
		}
	}

	private void AddToMOLog(AnswerObject mSubObj, String MTContent, MTType mMTType, String RequestID) throws Exception
	{
		try
		{
			MyDataRow mRow_Log = mTable_MOLog.CreateNewRow();

			mRow_Log.SetValueCell("MSISDN", mSubObj.MSISDN);

			mRow_Log.SetValueCell("LogDate", DateFormat_InsertDB.format(Calendar.getInstance().getTime()));
			mRow_Log.SetValueCell("ChannelTypeID", MyConfig.ChannelType.SYSTEM.GetValue());
			mRow_Log.SetValueCell("ChannelTypeName", MyConfig.ChannelType.SYSTEM.toString());
			mRow_Log.SetValueCell("MTTypeID", mMTType.GetValue());
			mRow_Log.SetValueCell("MTTypeName", mMTType.toString());
			mRow_Log.SetValueCell("MO", "");
			mRow_Log.SetValueCell("MT", MTContent);
			mRow_Log.SetValueCell("LogContent", "Send MT Result Match");
			mRow_Log.SetValueCell("PID", mSubObj.PID);
			mRow_Log.SetValueCell("RequestID", RequestID);

			mTable_MOLog.AddNewRow(mRow_Log);

		}
		catch (Exception ex)
		{
			mLog.log.error(ex);
		}
	}

	private void Insert_MOLog() throws Exception
	{
		try
		{
			if (mTable_MOLog.IsEmpty())
				return;

			mMOLog.Insert(0, mTable_MOLog.GetXML());

		}
		catch (Exception ex)
		{
			mLog.log.error(ex);
		}
		finally
		{
			mTable_MOLog.Clear();
		}
	}

	/**
	 * Lấy dữ liệu từ database
	 * 
	 * @return
	 * @throws Exception
	 */
	public MyTableModel GetSubscriber(Integer PID) throws Exception
	{
		try
		{
			return mAnswer.Select(5, mFMObject.RowCount.toString(), PID.toString(), mFMObject.MaxOrderID.toString(), mFMObject.ProcessNumber.toString(),
					mFMObject.ProcessIndex.toString());
		}
		catch (Exception ex)
		{
			throw ex;
		}
	}

}